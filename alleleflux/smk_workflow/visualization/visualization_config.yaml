# ==============================================================================
# AlleleFlux Visualization Workflow Configuration
# ==============================================================================

# --- General Settings ---
run_name: "alleleflux_visualization"

# Base directory for all output files generated by the workflow
output_dir: "/scratch/gpfs/AMOELLER/sidd/diet_manip/plotting_smk_cov3_freq_change"

# Resource allocation
resources:
  threads_per_job: 16
  mem_per_job: "100G"            # Memory per job. Formats: "8G", "100G", "102400M"

# Optional: List of specific MAGs to process. If provided, only these MAGs will be tracked and plotted.
# specific_mags: ["MAG_1", "MAG_2"]
# specific_mags: ["SLG441_DASTool_bins_SLG441_bin.23_sub", "SLG193_DASTool_bins_10", "SLG594_DASTool_bins_SLG594_bin.002_sub", "SLG529_DASTool_bins_72", "SLG1122_DASTool_bins_50", "SLG443_DASTool_bins_SLG443_bin.96"]

# ==============================================================================
# Step 1: Metadata Preparation
# ==============================================================================
# Configuration for cleaning and combining multiple metadata sources.
# Each entry in 'metadata_params' represents a distinct dataset/run.

metadata_params:
  - name: "longitudinal"
    path: "/scratch/gpfs/AMOELLER/diet_manip/copy_sg4230_scratch/sg4230/popgentoolkit/metadata_md_bam.tsv"
    base_profile_dir: "/scratch/gpfs/AMOELLER/diet_manip/AlleleFlux_mapq20/longitudinal/profiles"
    # Optional column mappings (defaults shown in comments):
    # sample_col: "sample"
    # group_col: "diet_group"
    # time_col: "timepoint"
    # day_col: "order"
    # replicate_col: "replicate"
    # subject_col: "mouse_id"

  - name: "hackflex"
    path: "/scratch/gpfs/AMOELLER/diet_manip/copy_sg4230_scratch/sg4230/popgentoolkit/hackflex_metadata_final.txt"
    base_profile_dir: "/scratch/gpfs/AMOELLER/diet_manip/AlleleFlux_mapq20_hackflex/single_timepoint/profiles"
    # sample_col: "sample_id"
    # group_col: "group"
    # time_col: "time"
    # day_col: "day"
    # replicate_col: "replicate"
    # subject_col: "subjectID"

# ==============================================================================
# Step 2: Terminal Nucleotide Analysis
# ==============================================================================
# Inputs for identifying terminal nucleotides in significant sites.

# Path to the file containing significant sites (output from AlleleFlux Step 2)
significant_sites_file: "/scratch/gpfs/AMOELLER/diet_manip/AlleleFlux_mapq20/longitudinal/p_value_summary/pre_end-fat_control/p_value_summary_two_sample_paired_pre_end.tsv"

# Directory containing nucleotide frequency profiles for the analysis
profile_dir: "/scratch/gpfs/AMOELLER/diet_manip/AlleleFlux_mapq20/longitudinal/profiles"

# Metadata file used for this specific analysis step (usually one of the inputs above)
metadata: "/scratch/gpfs/AMOELLER/diet_manip/copy_sg4230_scratch/sg4230/popgentoolkit/metadata_md_bam.tsv"

# Parameters for defining "terminal" samples and filtering sites
analysis_params:
  group: "fat"              # The group to analyze (e.g., treatment group)
  timepoint: "end"          # The timepoint representing the terminal state
  p_value_column: "q_value" # Column to use for significance filtering ('min_p_value' or 'q_value')
  p_value_threshold: 0.05   # Threshold for significance
  test_type: "two_sample_paired_tTest" # Statistical test used to generate p-values
  # group_analyzed: "optional_group_name" # Optional: Filter by 'group_analyzed' column if present
  
  # Optional: Initial timepoint for frequency change analysis
  # When provided, enables calculation of terminal nucleotide based on greatest
  # positive frequency change (terminal - initial). Requires 'subjectID' column in metadata.
  initial_timepoint: "pre"  # Set to null or remove to disable frequency change method

# ==============================================================================
# Step 3: Allele Frequency Tracking
# ==============================================================================
# Parameters for tracking allele frequencies across all samples based on terminal nucleotides.

tracking_params:
  # Column in terminal nucleotide output to use as the reference allele
  # Options: "terminal_nucleotide_majority_vote", "terminal_nucleotide_mean_freq",
  #          or "terminal_nucleotide_freq_change" (requires initial_timepoint above)
  anchor_column: "terminal_nucleotide_freq_change"
  
  # Minimum coverage required at a site to include it in the frequency tracking
  min_cov_per_site: 3

# ==============================================================================
# Step 4: Plotting
# ==============================================================================
# Parameters for plotting allele frequency trajectories.

plotting_params:
  value_col: "min_p_value"       # Column used to rank sites ('q_value' or 'min_p_value')
  n_sites_line: 2000         # Number of top sites for combined line plots
  # n_sites_dist: 100        # Number of top sites for box/violin plots
  n_sites_per_site: 3      # Number of top sites for per-site plots (defaults to n_sites_line if not set)
  x_col: "day"               # X-axis column ('time' or 'day')
  x_order: []                # Optional: Explicit order for x-axis (e.g., ["T1", "T2"])
  plot_types: ["line"] # List of plot types to generate
  per_site: True             # Generate individual plots for each site
  output_format: "png"       # Output format (png, pdf, svg)

  # Advanced plotting options
  bin_width_days: 10         # Optional: Bin width in days (requires x_col="day")
  min_samples_per_bin: 2     # Minimum valid samples required per bin
  group_by_replicate: True   # Group by replicate in per-site plots
  line_alpha: 0.1            # Line transparency (0-1)